#!/bin/bash

echo "๐ ะะฒัะพะผะฐัะธัะตัะบะพะต ัะฐะทะฒะตัััะฒะฐะฝะธะต Telegram CRM Bot"
echo "=================================================="

# ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั Docker
if ! command -v docker &> /dev/null; then
    echo "โ Docker ะฝะต ัััะฐะฝะพะฒะปะตะฝ. ะฃััะฐะฝะพะฒะธัะต Docker ะธ Docker Compose"
    exit 1
fi

if ! command -v docker-compose &> /dev/null; then
    echo "โ Docker Compose ะฝะต ัััะฐะฝะพะฒะปะตะฝ. ะฃััะฐะฝะพะฒะธัะต Docker Compose"
    exit 1
fi

echo "โ Docker ะธ Docker Compose ะฝะฐะนะดะตะฝั"

# ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั .env ัะฐะนะปะฐ
if [ ! -f .env ]; then
    echo "๐ ะกะพะทะดะฐะฝะธะต .env ัะฐะนะปะฐ ะธะท ะฟัะธะผะตัะฐ..."
    cp env.example .env
    echo "โ๏ธ  ะะะะะะะะ: ะััะตะดะฐะบัะธััะนัะต .env ัะฐะนะป ะธ ะดะพะฑะฐะฒััะต ะฒะฐั TELEGRAM_TOKEN ะธ SECRET_KEY"
    echo "๐ ะะฐัะตะผ ะทะฐะฟัััะธัะต ััะพั ัะบัะธะฟั ัะฝะพะฒะฐ"
    exit 1
fi

# ะัะพะฒะตัะบะฐ ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั
if grep -q "your_telegram_bot_token_here" .env; then
    echo "โ ะะจะะะะ: TELEGRAM_TOKEN ะฝะต ะฝะฐัััะพะตะฝ ะฒ .env ัะฐะนะปะต"
    echo "๐ ะััะตะดะฐะบัะธััะนัะต .env ัะฐะนะป ะธ ะดะพะฑะฐะฒััะต ะฒะฐั ัะพะบะตะฝ ะฑะพัะฐ"
    exit 1
fi

if grep -q "your_secret_key_here" .env; then
    echo "โ ะะจะะะะ: SECRET_KEY ะฝะต ะฝะฐัััะพะตะฝ ะฒ .env ัะฐะนะปะต"
    echo "๐ ะััะตะดะฐะบัะธััะนัะต .env ัะฐะนะป ะธ ะดะพะฑะฐะฒััะต ัะตะบัะตัะฝัะน ะบะปัั"
    exit 1
fi

echo "โ ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั ะฝะฐัััะพะตะฝั"

# ะกะพะทะดะฐะฝะธะต ะดะธัะตะบัะพัะธะน
echo "๐ ะกะพะทะดะฐะฝะธะต ะดะธัะตะบัะพัะธะน..."
mkdir -p data logs

# ะััะฐะฝะพะฒะบะฐ ัััะตััะฒัััะธั ะบะพะฝัะตะนะฝะตัะพะฒ
echo "๐ ะััะฐะฝะพะฒะบะฐ ัััะตััะฒัััะธั ะบะพะฝัะตะนะฝะตัะพะฒ..."
docker-compose down

# ะกะฑะพัะบะฐ ะพะฑัะฐะทะฐ
echo "๐จ ะกะฑะพัะบะฐ Docker ะพะฑัะฐะทะฐ..."
docker-compose build --no-cache

# ะะฐะฟััะบ ะบะพะฝัะตะนะฝะตัะพะฒ
echo "๐ ะะฐะฟััะบ ะบะพะฝัะตะนะฝะตัะพะฒ..."
docker-compose up -d

# ะะถะธะดะฐะฝะธะต ะทะฐะฟััะบะฐ
echo "โณ ะะถะธะดะฐะฝะธะต ะทะฐะฟััะบะฐ ัะตัะฒะธัะพะฒ..."
sleep 10

# ะัะพะฒะตัะบะฐ ััะฐัััะฐ
echo "๐ ะัะพะฒะตัะบะฐ ััะฐัััะฐ..."
if docker-compose ps | grep -q "Up"; then
    echo "โ ะะพะฝัะตะนะฝะตัั ะทะฐะฟััะตะฝั ััะฟะตัะฝะพ!"
    
    # ะัะพะฒะตัะบะฐ health check
    echo "๐ฅ ะัะพะฒะตัะบะฐ health check..."
    if curl -f http://localhost:8001/health > /dev/null 2>&1; then
        echo "โ Health check ะฟัะพะนะดะตะฝ!"
        echo ""
        echo "๐ ะะะะะะะขะซะะะะะ ะะะะะะจะะะ ะฃะกะะะจะะ!"
        echo "=================================================="
        echo "๐ ะะดะผะธะฝ ะฟะฐะฝะตะปั: http://localhost:8001"
        echo "๐ API ะดะพะบัะผะตะฝัะฐัะธั: http://localhost:8001/docs"
        echo "๐ Health check: http://localhost:8001/health"
        echo ""
        echo "๐ค ะะพะณะธะฝ ะฐะดะผะธะฝะฐ: admin"
        echo "๐ ะะฐัะพะปั ะฐะดะผะธะฝะฐ: admin123"
        echo ""
        echo "๐ ะัะพัะผะพัั ะปะพะณะพะฒ: docker-compose logs -f"
        echo "๐ ะััะฐะฝะพะฒะบะฐ: docker-compose down"
    else
        echo "โ๏ธ  Health check ะฝะต ะฟัะพะนะดะตะฝ, ะฝะพ ะบะพะฝัะตะนะฝะตัั ะทะฐะฟััะตะฝั"
        echo "๐ ะัะพะฒะตัััะต ะปะพะณะธ: docker-compose logs -f"
    fi
else
    echo "โ ะัะธะฑะบะฐ ะทะฐะฟััะบะฐ ะบะพะฝัะตะนะฝะตัะพะฒ"
    echo "๐ ะัะพะฒะตัััะต ะปะพะณะธ: docker-compose logs"
    exit 1
fi
