{% extends "base.html" %}

{% block title %}Статистика - CRM Админка{% endblock %}

{% block page_title %}
    <i class="fas fa-chart-line me-3 text-primary"></i>
    Статистика
{% endblock %}

{% block page_actions %}
    <button class="btn btn-primary" onclick="refreshDashboard()">
        <i class="fas fa-sync-alt me-2"></i>
        Обновить
    </button>
{% endblock %}

{% block content %}
<!-- Статистические карточки -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card h-100">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <div class="display-4 fw-bold" id="total-users-count">0</div>
                    <p class="text-muted mb-0">
                        <i class="fas fa-users me-2"></i>
                        Всего пользователей
                    </p>
                </div>
                <div class="text-end">
                    <i class="fas fa-users fa-2x text-white-50"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card h-100" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <div class="display-4 fw-bold" id="active-users-count">0</div>
                    <p class="text-muted mb-0">
                        <i class="fas fa-user-check me-2"></i>
                        Активных пользователей
                    </p>
                </div>
                <div class="text-end">
                    <i class="fas fa-user-check fa-2x text-white-50"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card h-100" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <div class="display-4 fw-bold" id="new-users-today">0</div>
                    <p class="text-muted mb-0">
                        <i class="fas fa-user-plus me-2"></i>
                        Новых сегодня
                    </p>
                </div>
                <div class="text-end">
                    <i class="fas fa-user-plus fa-2x text-white-50"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card h-100" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <div class="display-4 fw-bold" id="total-subscriptions-count">0</div>
                    <p class="text-muted mb-0">
                        <i class="fas fa-credit-card me-2"></i>
                        Всего подписок
                    </p>
                </div>
                <div class="text-end">
                    <i class="fas fa-credit-card fa-2x text-white-50"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Дополнительная статистика -->
<div class="row mb-4">
    <div class="col-xl-4 col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Активность подписок
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="flex-shrink-0">
                        <div class="bg-success rounded-circle d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                            <i class="fas fa-check fa-2x text-white"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h4 class="mb-1" id="active-subscriptions-count">0</h4>
                        <p class="text-muted mb-0">Активных подписок</p>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                            <i class="fas fa-clock fa-2x text-white"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h4 class="mb-1" id="expiring-subscriptions-count">0</h4>
                        <p class="text-muted mb-0">Истекают через неделю</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-4 col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-alt me-2"></i>
                    Регистрации за неделю
                </h5>
            </div>
            <div class="card-body">
                <div class="text-center">
                    <div class="display-3 fw-bold text-primary mb-2" id="new-users-week">0</div>
                    <p class="text-muted mb-3">Новых пользователей за последние 7 дней</p>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-primary" role="progressbar" style="width: 75%" id="week-progress"></div>
                    </div>
                    <small class="text-muted mt-2 d-block">Тренд роста</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-4 col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-tachometer-alt me-2"></i>
                    Быстрые действия
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-3">
                    <a href="/users" class="btn btn-outline-primary">
                        <i class="fas fa-users me-2"></i>
                        Управление пользователями
                    </a>
                    <a href="/subscriptions" class="btn btn-outline-success">
                        <i class="fas fa-credit-card me-2"></i>
                        Управление подписками
                    </a>
                    <button class="btn btn-outline-info" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt me-2"></i>
                        Обновить данные
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Последние пользователи -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-clock me-2"></i>
                    Последние пользователи
                </h5>
                <a href="/users" class="btn btn-sm btn-primary">
                    <i class="fas fa-external-link-alt me-1"></i>
                    Все пользователи
                </a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ФИО</th>
                                <th>Username</th>
                                <th>Дата регистрации</th>
                                <th>Статус подписки</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="recent-users-table">
                            <tr>
                                <td colspan="6" class="text-center text-muted py-4">
                                    <i class="fas fa-spinner fa-spin me-2"></i>
                                    Загрузка данных...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    loadDashboardData();
    loadRecentUsers();
});

function refreshDashboard() {
    loadDashboardData();
    loadRecentUsers();
    showAlert('Данные обновлены', 'success');
}

async function loadDashboardData() {
    try {
        const response = await fetch('/api/dashboard');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const stats = await response.json();
        
        // Обновляем статистику
        document.getElementById('total-users-count').textContent = stats.total_users || 0;
        document.getElementById('active-users-count').textContent = stats.active_users || 0;
        document.getElementById('new-users-today').textContent = stats.new_users_today || 0;
        document.getElementById('total-subscriptions-count').textContent = stats.total_subscriptions || 0;
        document.getElementById('active-subscriptions-count').textContent = stats.active_subscriptions || 0;
        document.getElementById('expiring-subscriptions-count').textContent = stats.expiring_subscriptions || 0;
        document.getElementById('new-users-week').textContent = stats.new_users_week || 0;
        
        // Обновляем прогресс бар
        const progressBar = document.getElementById('week-progress');
        const percentage = stats.new_users_week > 0 ? Math.min((stats.new_users_week / 10) * 100, 100) : 0;
        progressBar.style.width = `${percentage}%`;
        
    } catch (error) {
        console.error('Ошибка при загрузке данных дашборда:', error);
        showAlert(`Ошибка при загрузке данных: ${error.message}`, 'danger');
    }
}

async function loadRecentUsers() {
    try {
        const response = await fetch('/api/users?skip=0&limit=5');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        
        updateRecentUsersTable(data.users || []);
        
    } catch (error) {
        console.error('Ошибка при загрузке последних пользователей:', error);
        showAlert(`Ошибка при загрузке пользователей: ${error.message}`, 'danger');
    }
}

function updateRecentUsersTable(users) {
    const tbody = document.getElementById('recent-users-table');
    
    if (users.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted py-4">
                    <i class="fas fa-users me-2"></i>
                    Пользователи не найдены
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = users.map(user => `
        <tr>
            <td>
                <span class="badge bg-secondary">#${user.id}</span>
            </td>
            <td>
                <div class="d-flex align-items-center">
                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                        <i class="fas fa-user text-white"></i>
                    </div>
                    <div>
                        <div class="fw-bold">${user.full_name || 'Не указано'}</div>
                        <small class="text-muted">${user.telegram_id}</small>
                    </div>
                </div>
            </td>
            <td>
                <span class="text-muted">@${user.username || 'Не указан'}</span>
            </td>
            <td>
                <div class="d-flex align-items-center">
                    <i class="fas fa-calendar-alt text-primary me-2"></i>
                    <span>${formatDate(user.registration_date)}</span>
                </div>
            </td>
            <td>
                ${getSubscriptionBadge(user.subscription_status)}
            </td>
            <td>
                <a href="/users/${user.id}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-eye me-1"></i>
                    Детали
                </a>
            </td>
        </tr>
    `).join('');
}

function getSubscriptionBadge(status) {
    if (status === 'Активна') {
        return '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Активна</span>';
    } else if (status === 'Истекла') {
        return '<span class="badge bg-warning"><i class="fas fa-clock me-1"></i>Истекла</span>';
    } else {
        return '<span class="badge bg-secondary"><i class="fas fa-times me-1"></i>Нет подписки</span>';
    }
}

function formatDate(dateString) {
    if (!dateString) return 'Не указана';
    const date = new Date(dateString);
    return date.toLocaleDateString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.main-content');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %} 